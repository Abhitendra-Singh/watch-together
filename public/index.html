<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Watch Together</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-4">Watch Together</h1>
    <p id="status" class="text-center text-yellow-400 mb-6">Status: Disconnected</p>

    <!-- Setup Section -->
    <div id="setup-section" class="bg-gray-800 p-4 rounded-lg mb-4 flex flex-col sm:flex-row gap-4 items-center">
      <div class="flex-grow w-full">
        <label for="room-name" class="block text-sm">Room Name</label>
        <input type="text" id="room-name" placeholder="Enter room" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"/>
      </div>
      <div class="flex-grow w-full">
        <label for="youtube-url" class="block text-sm">YouTube URL</label>
        <input type="text" id="youtube-url" placeholder="Paste a YouTube URL" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"/>
      </div>
      <div class="flex gap-2 pt-2 sm:pt-6">
        <button id="connect-btn" class="bg-blue-600 px-4 py-2 rounded">Connect</button>
        <button id="load-video-btn" disabled class="bg-green-600 px-4 py-2 rounded">Load Video</button>
      </div>
    </div>

    <!-- Video + Chat -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 bg-black rounded-lg overflow-hidden shadow-lg">
        <div id="player"></div>
      </div>
      <div id="chat-section" class="bg-gray-800 rounded-lg flex flex-col h-[50vh]" style="display:none;">
        <div class="p-4 border-b border-gray-700">
          <h2 class="text-xl font-semibold">Chat</h2>
        </div>
        <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto"></div>
        <form id="chat-form" class="p-4 border-t border-gray-700 flex gap-2">
          <input id="username-input" placeholder="Your Name" class="w-1/3 bg-gray-700 px-2 py-1 rounded"/>
          <input id="message-input" placeholder="Message..." class="flex-grow bg-gray-700 px-2 py-1 rounded"/>
          <button type="submit" class="bg-blue-600 px-4 py-2 rounded">Send</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const SIGNALING_SERVER_URL = window.location.origin;
    const ICE_SERVERS = [{ urls: "stun:stun.l.google.com:19302" }];
    let socket, peerConnection, syncChannel, chatChannel;
    let roomName, isInitiator=false, player, isPlayerReady=false, receivedState=false;

    // UI
    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connect-btn");
    const roomInput = document.getElementById("room-name");
    const urlInput = document.getElementById("youtube-url");
    const loadBtn = document.getElementById("load-video-btn");
    const chatSection = document.getElementById("chat-section");
    const chatForm = document.getElementById("chat-form");
    const unameInput = document.getElementById("username-input");
    const msgInput = document.getElementById("message-input");
    const chatMsgs = document.getElementById("chat-messages");

    // Load YouTube API
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    window.onYouTubeIframeAPIReady = () => {
      player = new YT.Player("player", {
        videoId: "M7lc1UVf-VE",
        events: { onReady: () => { isPlayerReady=true; statusEl.textContent="YouTube Player Ready"; },
                  onStateChange: onPlayerStateChange }
      });
    };

    function onPlayerStateChange(e) {
      if(receivedState){receivedState=false;return;}
      if(!syncChannel||syncChannel.readyState!=="open")return;
      const t = player.getCurrentTime();
      if(e.data===YT.PlayerState.PLAYING) syncChannel.send(JSON.stringify({type:"play",time:t}));
      if(e.data===YT.PlayerState.PAUSED) syncChannel.send(JSON.stringify({type:"pause",time:t}));
    }

    connectBtn.onclick=()=>{
      roomName=roomInput.value.trim();
      if(!roomName){alert("Enter room");return;}
      socket=io(SIGNALING_SERVER_URL);
      setupSocket();
      socket.emit("join_room",roomName);
    };

    function setupSocket(){
      socket.on("room_joined",()=>statusEl.textContent=`Joined ${roomName}`);
      socket.on("room_full",()=>statusEl.textContent="Room full");
      socket.on("start_peer_connection",(d)=>{isInitiator=d.isInitiator;createPeer();if(isInitiator){createChannels();makeOffer();}});
      socket.on("signal",async(d)=>{if(d.type==="offer"){await peerConnection.setRemoteDescription(d.sdp);const ans=await peerConnection.createAnswer();await peerConnection.setLocalDescription(ans);socket.emit("signal",{type:"answer",sdp:peerConnection.localDescription,roomName});}
        else if(d.type==="answer"){await peerConnection.setRemoteDescription(d.sdp);}
        else if(d.type==="ice-candidate"){await peerConnection.addIceCandidate(d.candidate);}
      });
      socket.on("peer_disconnected",()=>statusEl.textContent="Peer disconnected");
    }

    function createPeer(){
      peerConnection=new RTCPeerConnection({iceServers:ICE_SERVERS});
      peerConnection.onicecandidate=e=>{if(e.candidate)socket.emit("signal",{type:"ice-candidate",candidate:e.candidate,roomName});};
      peerConnection.ondatachannel=e=>{if(e.channel.label==="sync")syncChannel=e.channel,setupSync();if(e.channel.label==="chat")chatChannel=e.channel,setupChat();};
      peerConnection.onconnectionstatechange=()=>{if(peerConnection.connectionState==="connected"){statusEl.textContent="Connected!";loadBtn.disabled=false;chatSection.style.display="flex";}};
    }

    function createChannels(){
      syncChannel=peerConnection.createDataChannel("sync"); setupSync();
      chatChannel=peerConnection.createDataChannel("chat"); setupChat();
    }

    async function makeOffer(){
      const offer=await peerConnection.createOffer();await peerConnection.setLocalDescription(offer);
      socket.emit("signal",{type:"offer",sdp:peerConnection.localDescription,roomName});
    }

    function setupSync(){
      syncChannel.onmessage=(e)=>{const d=JSON.parse(e.data);receivedState=true;
        if(d.type==="load")player.loadVideoById(d.videoId);
        if(d.type==="play"){player.seekTo(d.time,true);player.playVideo();}
        if(d.type==="pause"){player.seekTo(d.time,true);player.pauseVideo();}
      };
    }

    function setupChat(){
      chatChannel.onmessage=(e)=>{const m=JSON.parse(e.data);appendChat(m.username,m.message,false);};
    }

    loadBtn.onclick=()=>{
      const id=extractVideoID(urlInput.value);
      if(id){
        player.loadVideoById(id);
        if(syncChannel?.readyState==="open"){
          syncChannel.send(JSON.stringify({type:"load",videoId:id}));
        }
      } else {
        alert("Invalid YouTube URL");
      }
    };

    chatForm.onsubmit=(e)=>{
      e.preventDefault();const msg=msgInput.value.trim();if(!msg||!chatChannel)return;
      const user=unameInput.value.trim()||"Anon";const m={username:user,message:msg};
      chatChannel.send(JSON.stringify(m));appendChat(user,msg,true);msgInput.value="";
    };

    function appendChat(user,msg,sender){
      const d=document.createElement("div");d.className=`p-2 rounded ${sender?"bg-blue-600 ml-auto":"bg-gray-600 mr-auto"}`;
      d.innerHTML=`<b>${user}</b>: ${msg}`;chatMsgs.appendChild(d);chatMsgs.scrollTop=chatMsgs.scrollHeight;
    }

    // ðŸ”‘ Fixed extractor
    function extractVideoID(url){
      const regExp=/^.*(?:youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]{11}).*/;
      const match=url.match(regExp);
      return match?match[1]:null;
    }
  </script>
</body>
</html>
